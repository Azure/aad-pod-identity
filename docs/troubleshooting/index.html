<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.75.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=alternate type=application/rss+xml href=https://azure.github.io/aad-pod-identity/docs/troubleshooting/index.xml><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/aad-pod-identity/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/aad-pod-identity/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/aad-pod-identity/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-192x192.png sizes=192x192><title>Troubleshooting | Azure Active Directory Pod Identity for Kubernetes</title><meta property="og:title" content="Troubleshooting"><meta property="og:description" content="An overview of a list of components to assist in troubleshooting."><meta property="og:type" content="website"><meta property="og:url" content="https://azure.github.io/aad-pod-identity/docs/troubleshooting/"><meta property="og:updated_time" content="2020-12-07T14:37:17-08:00"><meta property="og:site_name" content="Azure Active Directory Pod Identity for Kubernetes"><meta itemprop=name content="Troubleshooting"><meta itemprop=description content="An overview of a list of components to assist in troubleshooting."><meta name=twitter:card content="summary"><meta name=twitter:title content="Troubleshooting"><meta name=twitter:description content="An overview of a list of components to assist in troubleshooting."><link rel=preload href=/aad-pod-identity/scss/main.min.3ea58881782e4ff269e483a54676729c31b63711f1f727ae2946b23cf8ff2572.css as=style><link href=/aad-pod-identity/scss/main.min.3ea58881782e4ff269e483a54676729c31b63711f1f727ae2946b23cf8ff2572.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/aad-pod-identity/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Azure Active Directory Pod Identity for Kubernetes</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/aad-pod-identity/changelog/><span>Changelog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/aad-pod-identity/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/Azure/aad-pod-identity target=_blank><span>GitHub</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/aad-pod-identity/offline-search-index.3ea44486a4b6fa48aaa99ac713852f00f07a1677ca87e726fbeb59ae275f9b563f2a57d8beeae8bde47f8a048d0abdb77703c29f15c37580564c9da6ae56662c.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/aad-pod-identity/offline-search-index.3ea44486a4b6fa48aaa99ac713852f00f07a1677ca87e726fbeb59ae275f9b563f2a57d8beeae8bde47f8a048d0abdb77703c29f15c37580564c9da6ae56662c.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Documentation</a></li><ul><li class="collapse show" id=aad-pod-identitydocs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/getting-started/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Getting Started</a></li><ul><li class=collapse id=aad-pod-identitydocsgetting-started><a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsgetting-startedrole-assignment href=/aad-pod-identity/docs/getting-started/role-assignment/>Role Assignment</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsgetting-startedinstallation href=/aad-pod-identity/docs/getting-started/installation/>Installation</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/concepts/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Concepts</a></li><ul><li class=collapse id=aad-pod-identitydocsconcepts><a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsazureidentity href=/aad-pod-identity/docs/concepts/azureidentity/>AzureIdentity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsazureidentitybinding href=/aad-pod-identity/docs/concepts/azureidentitybinding/>AzureIdentityBinding</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsazureassignedidentity href=/aad-pod-identity/docs/concepts/azureassignedidentity/>AzureAssignedIdentity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsazurepodidentityexception href=/aad-pod-identity/docs/concepts/azurepodidentityexception/>AzurePodIdentityException</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsmic href=/aad-pod-identity/docs/concepts/mic/>Managed Identity Controller (MIC)</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsnmi href=/aad-pod-identity/docs/concepts/nmi/>Node Managed Identity (NMI)</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsblock-diagram-and-design href=/aad-pod-identity/docs/concepts/block-diagram-and-design/>Block Diagram and Design</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/demo/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Demos</a></li><ul><li class=collapse id=aad-pod-identitydocsdemo><a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsdemostandard_walkthrough href=/aad-pod-identity/docs/demo/standard_walkthrough/>Standard Walkthrough</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsdemotutorial href=/aad-pod-identity/docs/demo/tutorial/>AAD Pod Identity Tutorial</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsdemojava-blob href=/aad-pod-identity/docs/demo/java-blob/>Spring Boot + Azure Storage + AAD Pod Identity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsdemoquickstart href=/aad-pod-identity/docs/demo/quickstart/>Quickstart Demo</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/configure/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Configurations</a></li><ul><li class=collapse id=aad-pod-identitydocsconfigure><a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigurematch_pods_in_namespace href=/aad-pod-identity/docs/configure/match_pods_in_namespace/>Match Pods in the Namespace</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureaad_pod_identity_on_kubenet href=/aad-pod-identity/docs/configure/aad_pod_identity_on_kubenet/>Deploy AAD Pod Identity in a Cluster with Kubenet</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfiguredeploy_aad_pod_dedicated_sp href=/aad-pod-identity/docs/configure/deploy_aad_pod_dedicated_sp/>Deploy AAD Pod Identity with a Dedicated Service Principal</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureapplication_exception href=/aad-pod-identity/docs/configure/application_exception/>Disable AAD Pod Identity for a specific Pod/Application</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureazure_identity_validation href=/aad-pod-identity/docs/configure/azure_identity_validation/>Azure Identity Validation using Gatekeeper</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigurefeature_flags href=/aad-pod-identity/docs/configure/feature_flags/>Feature Flags</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigurecustom_cloud href=/aad-pod-identity/docs/configure/custom_cloud/>Pod Identity in Custom Cloud</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigurepod_identity_in_managed_mode href=/aad-pod-identity/docs/configure/pod_identity_in_managed_mode/>Pod Identity in Managed Mode</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureprometheus_monitoring href=/aad-pod-identity/docs/configure/prometheus_monitoring/>Monitoring Pod Identity with Prometheus</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureenable_psp_enabled_clusters href=/aad-pod-identity/docs/configure/enable_psp_enabled_clusters/>Enable PSP Clusters</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/best-practices/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Best Practices</a></li><ul><li class=collapse id=aad-pod-identitydocsbest-practices></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/known-issues/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Known Issues</a></li><ul><li class=collapse id=aad-pod-identitydocsknown-issues></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/contributing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Contributing</a></li><ul><li class=collapse id=aad-pod-identitydocscontributing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/troubleshooting/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Troubleshooting</a></li><ul><li class="collapse show" id=aad-pod-identitydocstroubleshooting></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/support/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Support</a></li><ul><li class=collapse id=aad-pod-identitydocssupport></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/code-of-conduct/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Code of Conduct</a></li><ul><li class=collapse id=aad-pod-identitydocscode-of-conduct></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/Azure/aad-pod-identity/edit/master/website/content/en/docs/Troubleshooting/_index.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/Azure/aad-pod-identity/issues/new?title=Troubleshooting" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href="https://github.com/Azure/aad-pod-identity/issues/new?assignees=&labels=bug&template=bug_report.md&title=/issues/new" target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#logging>Logging</a><ul><li><a href=#isolate-errors-from-logs>Isolate errors from logs</a></li><li><a href=#ensure-that-iptables-rule-exists>Ensure that iptables rule exists</a></li><li><a href=#run-a-pod-to-validate-your-identity-setup>Run a pod to validate your identity setup</a></li></ul></li><li><a href=#common-issues>Common Issues</a><ul><li><a href=#ignoring-azure-identity-podnspodname-error-invalid-resource-id--must-match-subscriptionssubidresourcegroupsresourcegroupprovidersmicrosoftmanagedidentityuserassignedidentitiesname>Ignoring azure identity &lt;podns>/&lt;podname>, error: Invalid resource id: &ldquo;&rdquo;, must match /subscriptions/&lt;subid>/resourcegroups/&lt;resourcegroup>/providers/Microsoft.ManagedIdentity/userAssignedIdentities/&lt;name></a></li><li><a href=#linkedauthorizationfailed>LinkedAuthorizationFailed</a></li><li><a href=#unable-to-remove-azureassignedidentity-after-mic-pods-are-deleted>Unable to remove <code>AzureAssignedIdentity</code> after MIC pods are deleted</a></li><li><a href=#token-requests-calls-fail-with-io-timeout>Token requests calls fail with i/o timeout</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=https://azure.github.io/aad-pod-identity/docs/>Documentation</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://azure.github.io/aad-pod-identity/docs/troubleshooting/>Troubleshooting</a></li></ol></nav><div class=td-content><h1>Troubleshooting</h1><div class=lead>An overview of a list of components to assist in troubleshooting.</div><h2 id=logging>Logging</h2><p>Below is a list of commands you can use to view relevant logs of aad-pod-identity components.</p><h3 id=isolate-errors-from-logs>Isolate errors from logs</h3><p>You can use <code>grep ^E</code> and <code>--since</code> flag from <code>kubectl</code> to isolate any errors occurred after a given duration.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl logs -l <span style=color:#000>component</span><span style=color:#ce5c00;font-weight:700>=</span>mic --since<span style=color:#ce5c00;font-weight:700>=</span>1h <span style=color:#000;font-weight:700>|</span> grep ^E
kubectl logs -l <span style=color:#000>component</span><span style=color:#ce5c00;font-weight:700>=</span>nmi --since<span style=color:#ce5c00;font-weight:700>=</span>1h <span style=color:#000;font-weight:700>|</span> grep ^E
</code></pre></div><blockquote><p>It is always a good idea to include relevant logs from MIC and NMI when opening a new <a href=https://github.com/Azure/aad-pod-identity/issues>issue</a>.</p></blockquote><h3 id=ensure-that-iptables-rule-exists>Ensure that iptables rule exists</h3><p>To ensure that the correct iptables rule is injected to each node via the <a href=../concepts/nmi>NMI</a> pods, the following command ensures that on a given node, there exists an iptables rule where all packets with a destination IP of 169.254.169.254 (IMDS endpoint) are routed to port 2579 of the host network.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>NMI_POD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get pod -l <span style=color:#000>component</span><span style=color:#ce5c00;font-weight:700>=</span>nmi -ojsonpath<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[?(@.spec.nodeName==&#34;&lt;NodeName&gt;&#34;)].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
kubectl <span style=color:#204a87>exec</span> <span style=color:#000>$NMI_POD</span> -- iptables -t nat -S aad-metadata
</code></pre></div><p>The expected output should be:</p><pre><code class=language-log data-lang=log>-N aad-metadata
-A aad-metadata ! -s 127.0.0.1/32 -d 169.254.169.254/32 -p tcp -m tcp --dport 80 -j DNAT --to-destination 10.240.0.34:2579
-A aad-metadata -j RETURN
</code></pre><h3 id=run-a-pod-to-validate-your-identity-setup>Run a pod to validate your identity setup</h3><p>You could run the following commands to validate your identity setup (assuming you have the proper <code>AzureIdentity</code> and <code>AzureIdentityBinding</code> deployed):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl run azure-cli -it --image<span style=color:#ce5c00;font-weight:700>=</span>mcr.microsoft.com/azure-cli --labels<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>aadpodidbinding</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;selector defined in AzureIdentityBinding&gt; /bin/bash

<span style=color:#8f5902;font-style:italic># within the azure-cli shell</span>
az login -i --debug
</code></pre></div><p><code>az login -i</code> will use the Azure identity bound to the <code>azure-cli</code> pod and perform a login to Azure via Azure CLI. If succeeded, you would have an output as below:</p><pre><code class=language-log data-lang=log>urllib3.connectionpool : Starting new HTTP connection (1): 169.254.169.254:80
urllib3.connectionpool : http://169.254.169.254:80 &quot;GET /metadata/identity/oauth2/token?resource=https%3A%2F%2Fmanagement.core.windows.net%2F&amp;api-version=2018-02-01 HTTP/1.1&quot; 200 1667
msrestazure.azure_active_directory : MSI: Retrieving a token from http://169.254.169.254/metadata/identity/oauth2/token, with payload {'resource': 'https://management.core.windows.net/', 'api-version': '2018-02-01'}
msrestazure.azure_active_directory : MSI: Token retrieved
MSI: token was retrieved. Now trying to initialize local accounts...
...
[
  {
    &quot;environmentName&quot;: &quot;AzureCloud&quot;,
    &quot;homeTenantId&quot;: &quot;&lt;REDACTED&gt;&quot;,
    &quot;id&quot;: &quot;&lt;REDACTED&gt;&quot;,
    &quot;isDefault&quot;: true,
    &quot;managedByTenants&quot;: [],
    &quot;name&quot;: &quot;&lt;REDACTED&gt;&quot;,
    &quot;state&quot;: &quot;Enabled&quot;,
    &quot;tenantId&quot;: &quot;&lt;REDACTED&gt;&quot;,
    &quot;user&quot;: {
      &quot;assignedIdentityInfo&quot;: &quot;MSI&quot;,
      &quot;name&quot;: &quot;systemAssignedIdentity&quot;,
      &quot;type&quot;: &quot;servicePrincipal&quot;
    }
  }
]
</code></pre><p>Based on the logs above, Azure CLI was able to retrieve a token from <code>http://169.254.169.254:80/metadata/identity/oauth2/token</code>. Its request is routed to the NMI pod that is running within the same node. Identify which node the Azure CLI pod is scheduled to by running the following command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get pods -owide

NAME                                    READY   STATUS    RESTARTS   AGE   IP             NODE                                 NOMINATED NODE   READINESS GATES
azure-cli                               1/1     Running   <span style=color:#0000cf;font-weight:700>1</span>          12s   10.240.0.117   k8s-agentpool1-95854893-vmss000002   &lt;none&gt;           &lt;none&gt;
</code></pre></div><p>Take a note at the node the pod is scheduled to and its IP address. Check the logs of the NMI pod that is scheduled to the same node. You should be able to see a token requested by the azure-cli pod, identified by its pod IP address <code>10.240.0.117</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl logs &lt;nmi pod name&gt;

...
I0821 18:22:50.810806       <span style=color:#0000cf;font-weight:700>1</span> standard.go:72<span style=color:#ce5c00;font-weight:700>]</span> no clientID or resourceID in request. default/azure-cli has been matched with azure identity default/demo
I0821 18:22:50.810895       <span style=color:#0000cf;font-weight:700>1</span> standard.go:178<span style=color:#ce5c00;font-weight:700>]</span> matched identityType:0 clientid:7eb6##### REDACTED <span style=color:#8f5902;font-style:italic>#####a6a9 resource:https://management.core.windows.net/</span>
I0821 18:22:51.348117       <span style=color:#0000cf;font-weight:700>1</span> server.go:190<span style=color:#ce5c00;font-weight:700>]</span> status <span style=color:#ce5c00;font-weight:700>(</span>200<span style=color:#ce5c00;font-weight:700>)</span> took <span style=color:#0000cf;font-weight:700>537597287</span> ns <span style=color:#204a87;font-weight:700>for</span> req.method<span style=color:#ce5c00;font-weight:700>=</span>GET reg.path<span style=color:#ce5c00;font-weight:700>=</span>/metadata/identity/oauth2/token req.remote<span style=color:#ce5c00;font-weight:700>=</span>10.240.0.117
...
</code></pre></div><h2 id=common-issues>Common Issues</h2><p>Common issues or questions that users have run into when using pod identity are detailed below.</p><h3 id=ignoring-azure-identity-podnspodname-error-invalid-resource-id--must-match-subscriptionssubidresourcegroupsresourcegroupprovidersmicrosoftmanagedidentityuserassignedidentitiesname>Ignoring azure identity &lt;podns>/&lt;podname>, error: Invalid resource id: &ldquo;&rdquo;, must match /subscriptions/&lt;subid>/resourcegroups/&lt;resourcegroup>/providers/Microsoft.ManagedIdentity/userAssignedIdentities/&lt;name></h3><p>If you are using MIC v1.6.0+, you will need to ensure the correct capitalization of <code>AzureIdentity</code> and <code>AzureIdentityBinding</code> fields. For more information, please refer to <a href=../#v160-breaking-change>this section</a>.</p><h3 id=linkedauthorizationfailed>LinkedAuthorizationFailed</h3><p>If you received the following error message in MIC:</p><pre><code class=language-log data-lang=log>Code=&quot;LinkedAuthorizationFailed&quot; Message=&quot;The client '&lt;ClientID&gt;' with object id '&lt;ObjectID&gt;' has permission to perform action 'Microsoft.Compute/&lt;VMType&gt;/write' on scope '&lt;VM/VMSS scope&gt;'; however, it does not have permission to perform action 'Microsoft.ManagedIdentity/userAssignedIdentities/assign/action' on the linked scope(s) '&lt;UserAssignedIdentityScope&gt;' or the linked scope(s) are invalid.&quot;
</code></pre><p>It means that your cluster service principal / managed identity does not have the correct role assignment to assign the chosen user-assigned identities to the VM/VMSS. For more information, please follow this <a href=../getting-started/role-assignment/>documentation</a> to allow your cluster service principal / managed identity to perform identity-related operation.</p><p>Past issues:</p><ul><li><a href=https://github.com/Azure/aad-pod-identity/issues/585>https://github.com/Azure/aad-pod-identity/issues/585</a></li></ul><h3 id=unable-to-remove-azureassignedidentity-after-mic-pods-are-deleted>Unable to remove <code>AzureAssignedIdentity</code> after MIC pods are deleted</h3><p>With release <code>1.6.1</code>, finalizers have been added to <code>AzureAssignedIdentity</code> to ensure the identities are successfully cleaned up by MIC before they&rsquo;re deleted. However, in scenarios where the MIC deployment is force deleted before it has completed the clean up of identities from the underlying node, the <code>AzureAssignedIdentity</code> will be left behind as it contains a finalizer.</p><p>To delete all <code>AzureAssignedIdentity</code>, run the following command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get azureassignedidentity -A -o<span style=color:#ce5c00;font-weight:700>=</span>json <span style=color:#000;font-weight:700>|</span> jq <span style=color:#4e9a06>&#39;.items[].metadata.finalizers=null&#39;</span> <span style=color:#000;font-weight:700>|</span> kubectl apply -f -
kubectl delete azureassignedidentity --all
</code></pre></div><p>To delete only a specific <code>AzureAssignedIdentity</code>, run the following command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get azureassignedidentity &lt;name&gt; -n &lt;namespace&gt; -o<span style=color:#ce5c00;font-weight:700>=</span>json <span style=color:#000;font-weight:700>|</span> jq <span style=color:#4e9a06>&#39;.items[].metadata.finalizers=null&#39;</span> <span style=color:#000;font-weight:700>|</span> kubectl apply -f -
kubectl delete azureassignedidentity &lt;name&gt; -n &lt;namespace&gt;
</code></pre></div><p>Past issues:</p><ul><li><a href=https://github.com/Azure/aad-pod-identity/issues/644>https://github.com/Azure/aad-pod-identity/issues/644</a></li></ul><h3 id=token-requests-calls-fail-with-io-timeout>Token requests calls fail with i/o timeout</h3><p>If you received the following or similar error in your application:</p><pre><code class=language-log data-lang=log>azure.BearerAuthorizer#WithAuthorization: Failed to refresh the Token for request to https://management.azure.com/subscriptions/subId/resourceGroups/rg/providers/Microsoft.Network/dnsZones?api-version=2018-05-01: StatusCode=0 -- Original Error: adal: Failed to execute the refresh request. Error = 'Get \&quot;http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&amp;resource=https%3A%2F%2Fmanagement.core.windows.net%2F\&quot;: dial tcp 169.254.169.254:80: i/o timeout'
</code></pre><p>It means there is a network policy blocking egress traffic to <code>169.254.169.254</code> from the host. NMI pods run on <code>hostNetwork</code> and listen on <code>127.0.0.1:2579</code>. Please ensure there is a network policy that allows traffic to <code>127.0.0.1:2579</code>. Example <code>GlobalNetworPolicy</code> configuration for Calico:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GlobalNetworkPolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>crd.projectcalico.org/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>egress-localhost</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>types</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>Egress</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>egress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>action</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Allow</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCP</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>destination</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>nets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#0000cf;font-weight:700>127.0.0.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>2579</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Past issues:</p><ul><li><a href=https://github.com/Azure/aad-pod-identity/issues/716>https://github.com/Azure/aad-pod-identity/issues/716</a></li><li><a href=https://github.com/Azure/aad-pod-identity/issues/821>https://github.com/Azure/aad-pod-identity/issues/821</a></li></ul><div class=section-index><hr class=panel-line></div><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="feedback--answer feedback--answer-yes">Yes</button>
<button class="feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/Azure/aad-pod-identity/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/Azure/aad-pod-identity/issues/new>tell us how we can improve</a>.</p><script>const yesButton=document.querySelector('.feedback--answer-yes');const noButton=document.querySelector('.feedback--answer-no');const yesResponse=document.querySelector('.feedback--response-yes');const noResponse=document.querySelector('.feedback--response-no');const disableButtons=()=>{yesButton.disabled=true;noButton.disabled=true;};const sendFeedback=(value)=>{if(typeof ga!=='function')return;const args={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:value};ga(args.command,args.hitType,args.category,args.action,args.label,args.value);};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible');disableButtons();sendFeedback(1);});noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible');disableButtons();sendFeedback(0);});</script><br><div class="text-muted mt-5 pt-3 border-top">Last modified December 7, 2020: <a href=https://github.com/Azure/aad-pod-identity/commit/cc39f9fc33d1c945c0aa8337c753ee95c04e5dab>docs: update troubleshooting doc for network policies (#900) (cc39f9f)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/Azure/aad-pod-identity><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2021 Azure Compute OSS Upstream Team All Rights Reserved</small></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/aad-pod-identity/js/main.min.664f21bf5eb0c31ebc661e2616e6c63e0448cec6d5636d869957be423c3cb952.js integrity="sha256-Zk8hv16wwx68Zh4mFubGPgRIzsbVY22GmVe+Qjw8uVI=" crossorigin=anonymous></script></body></html>