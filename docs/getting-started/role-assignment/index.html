<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.75.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/aad-pod-identity/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/aad-pod-identity/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/aad-pod-identity/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-192x192.png sizes=192x192><title>Role Assignment | Azure Active Directory Pod Identity for Kubernetes</title><meta property="og:title" content="Role Assignment"><meta property="og:description" content="Your cluster will need the correct role assignment configuration to perform Azure-related operations."><meta property="og:type" content="article"><meta property="og:url" content="https://azure.github.io/aad-pod-identity/docs/getting-started/role-assignment/"><meta property="article:modified_time" content="2021-02-16T13:28:51-05:00"><meta property="og:site_name" content="Azure Active Directory Pod Identity for Kubernetes"><meta itemprop=name content="Role Assignment"><meta itemprop=description content="Your cluster will need the correct role assignment configuration to perform Azure-related operations."><meta itemprop=dateModified content="2021-02-16T13:28:51-05:00"><meta itemprop=wordCount content="847"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Role Assignment"><meta name=twitter:description content="Your cluster will need the correct role assignment configuration to perform Azure-related operations."><link rel=preload href=/aad-pod-identity/scss/main.min.3ea58881782e4ff269e483a54676729c31b63711f1f727ae2946b23cf8ff2572.css as=style><link href=/aad-pod-identity/scss/main.min.3ea58881782e4ff269e483a54676729c31b63711f1f727ae2946b23cf8ff2572.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/aad-pod-identity/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Azure Active Directory Pod Identity for Kubernetes</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/aad-pod-identity/changelog/><span>Changelog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/aad-pod-identity/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/Azure/aad-pod-identity target=_blank><span>GitHub</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/aad-pod-identity/offline-search-index.4edb0917495ddbf7be5a18e3143f7618bc053830b47783538a2b70088ba6d55a818a0e4b2a25648b862eba5fb61223443c90b8745bbcb9e72842dc61d290813a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/aad-pod-identity/offline-search-index.4edb0917495ddbf7be5a18e3143f7618bc053830b47783538a2b70088ba6d55a818a0e4b2a25648b862eba5fb61223443c90b8745bbcb9e72842dc61d290813a.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Documentation</a></li><ul><li class="collapse show" id=aad-pod-identitydocs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/getting-started/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Getting Started</a></li><ul><li class="collapse show" id=aad-pod-identitydocsgetting-started><a class="td-sidebar-link td-sidebar-link__page active" id=m-aad-pod-identitydocsgetting-startedrole-assignment href=/aad-pod-identity/docs/getting-started/role-assignment/>Role Assignment</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsgetting-startedinstallation href=/aad-pod-identity/docs/getting-started/installation/>Installation</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/concepts/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Concepts</a></li><ul><li class=collapse id=aad-pod-identitydocsconcepts><a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsazureidentity href=/aad-pod-identity/docs/concepts/azureidentity/>AzureIdentity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsazureidentitybinding href=/aad-pod-identity/docs/concepts/azureidentitybinding/>AzureIdentityBinding</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsazureassignedidentity href=/aad-pod-identity/docs/concepts/azureassignedidentity/>AzureAssignedIdentity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsazurepodidentityexception href=/aad-pod-identity/docs/concepts/azurepodidentityexception/>AzurePodIdentityException</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsmic href=/aad-pod-identity/docs/concepts/mic/>Managed Identity Controller (MIC)</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsnmi href=/aad-pod-identity/docs/concepts/nmi/>Node Managed Identity (NMI)</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsblock-diagram-and-design href=/aad-pod-identity/docs/concepts/block-diagram-and-design/>Block Diagram and Design</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/demo/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Demos</a></li><ul><li class=collapse id=aad-pod-identitydocsdemo><a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsdemostandard_walkthrough href=/aad-pod-identity/docs/demo/standard_walkthrough/>Standard Walkthrough</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsdemotutorial href=/aad-pod-identity/docs/demo/tutorial/>AAD Pod Identity Tutorial</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsdemojava-blob href=/aad-pod-identity/docs/demo/java-blob/>Spring Boot + Azure Storage + AAD Pod Identity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsdemoquickstart href=/aad-pod-identity/docs/demo/quickstart/>Quickstart Demo</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/configure/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Configurations</a></li><ul><li class=collapse id=aad-pod-identitydocsconfigure><a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigurematch_pods_in_namespace href=/aad-pod-identity/docs/configure/match_pods_in_namespace/>Match Pods in the Namespace</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureaad_pod_identity_on_kubenet href=/aad-pod-identity/docs/configure/aad_pod_identity_on_kubenet/>Deploy AAD Pod Identity in a Cluster with Kubenet</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfiguredeploy_aad_pod_dedicated_sp href=/aad-pod-identity/docs/configure/deploy_aad_pod_dedicated_sp/>Deploy AAD Pod Identity with a Dedicated Service Principal</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureapplication_exception href=/aad-pod-identity/docs/configure/application_exception/>Disable AAD Pod Identity for a specific Pod/Application</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureazure_identity_validation href=/aad-pod-identity/docs/configure/azure_identity_validation/>Azure Identity Validation using Gatekeeper</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigurefeature_flags href=/aad-pod-identity/docs/configure/feature_flags/>Feature Flags</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigurecustom_cloud href=/aad-pod-identity/docs/configure/custom_cloud/>Pod Identity in Custom Cloud</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigurepod_identity_in_managed_mode href=/aad-pod-identity/docs/configure/pod_identity_in_managed_mode/>Pod Identity in Managed Mode</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureprometheus_monitoring href=/aad-pod-identity/docs/configure/prometheus_monitoring/>Monitoring Pod Identity with Prometheus</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureenable_psp_enabled_clusters href=/aad-pod-identity/docs/configure/enable_psp_enabled_clusters/>Enable PSP Clusters</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/best-practices/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Best Practices</a></li><ul><li class=collapse id=aad-pod-identitydocsbest-practices></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/known-issues/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Known Issues</a></li><ul><li class=collapse id=aad-pod-identitydocsknown-issues></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/contributing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Contributing</a></li><ul><li class=collapse id=aad-pod-identitydocscontributing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/troubleshooting/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Troubleshooting</a></li><ul><li class=collapse id=aad-pod-identitydocstroubleshooting></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/support/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Support</a></li><ul><li class=collapse id=aad-pod-identitydocssupport></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/code-of-conduct/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Code of Conduct</a></li><ul><li class=collapse id=aad-pod-identitydocscode-of-conduct></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/Azure/aad-pod-identity/edit/master/website/content/en/docs/Getting%20started/role-assignment.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/Azure/aad-pod-identity/issues/new?title=Role%20Assignment" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href="https://github.com/Azure/aad-pod-identity/issues/new?assignees=&labels=bug&template=bug_report.md&title=/issues/new" target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#more-on-authentication-methods>More on authentication methods</a></li><li><a href=#obtaining-the-id-of-the-managed-identity--service-principal>Obtaining the ID of the managed identity / service principal</a></li><li><a href=#performing-role-assignments>Performing role assignments</a></li><li><a href=#user-assigned-identities-that-are-not-within-the-node-resource-group>User-assigned identities that are not within the node resource group</a></li><li><a href=#user-assigned-managed-identities-for-self-managed-clusters>User-assigned managed identities for self-managed clusters</a><ul><li><a href=#for-vmss>For VMSS</a></li><li><a href=#for-vms>For VMs</a></li></ul></li><li><a href=#reducing-number-of-role-assignments>Reducing number of role assignments</a></li><li><a href=#useful-links>Useful links</a></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=https://azure.github.io/aad-pod-identity/docs/>Documentation</a></li><li class=breadcrumb-item><a href=https://azure.github.io/aad-pod-identity/docs/getting-started/>Getting Started</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://azure.github.io/aad-pod-identity/docs/getting-started/role-assignment/>Role Assignment</a></li></ol></nav><div class=td-content><h1>Role Assignment</h1><div class=lead>Your cluster will need the correct role assignment configuration to perform Azure-related operations.</div><p>Your cluster will need the correct role assignment configuration to perform Azure-related operations such as assigning and un-assigning the identity on the underlying VM/VMSS. You can run the following commands to help you set up the appropriate role assignments for your cluster identity before deploying aad-pod-identity.</p><p>AKS and aks-engine clusters require an identity to communicate with Azure. This identity can be either a <strong>managed identity</strong> (in the form of system-assigned identity or user-assigned identity) or a <strong>service principal</strong>. This section explains various role assignments that need to be performed before using AAD Pod Identity. Without the proper role assignments, your Azure cluster will not have the correct permission to assign and un-assign identities from the underlying virtual machines (VM) or virtual machine scale sets (VMSS).</p><p>In the case of self-managed clusters (manual installation of Kubernetes on Azure VMs), you&rsquo;ll need to assign a <strong>user-assigned managed identity</strong> to the VM or VMSS or use a <strong>service principal</strong>. This is required for MIC to perform Azure-related operations for assigning/un-assigning the identity required for applications.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>SUBSCRIPTION_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&lt;SubscriptionID&gt;&#34;</span>
<span style=color:#204a87>export</span> <span style=color:#000>RESOURCE_GROUP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&lt;AKSResourceGroup&gt;&#34;</span>
<span style=color:#204a87>export</span> <span style=color:#000>CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&lt;AKSClusterName&gt;&#34;</span>

<span style=color:#8f5902;font-style:italic># Optional: if you are planning to deploy your user-assigned identities</span>
<span style=color:#8f5902;font-style:italic># in a separate resource group instead of your node resource group</span>
<span style=color:#204a87>export</span> <span style=color:#000>IDENTITY_RESOURCE_GROUP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&lt;IdentityResourceGroup&gt;&#34;</span>

curl -s https://raw.githubusercontent.com/Azure/aad-pod-identity/master/hack/role-assignment.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><blockquote><p>Note: <code>&lt;AKSResourceGroup></code> is where your AKS cluster is deployed to.</p></blockquote><h2 id=introduction>Introduction</h2><p>Currently, <a href=../../concepts/mic>MIC</a> uses one of the following two ways to authenticate with Azure:</p><ol><li><a href=https://docs.microsoft.com/en-us/azure/aks/use-managed-identity>Managed Identity</a> (system-assigned identity or user-assigned identity)</li><li><a href=https://docs.microsoft.com/en-us/azure/aks/kubernetes-service-principal>Service Principal</a> through <code>/etc/kubernetes/azure.json</code>, which is available in every node, or credentials defined by environment variables;</li></ol><blockquote><p>Clusters with managed identity are only compatible with AAD Pod Identity 1.5+.</p></blockquote><h2 id=more-on-authentication-methods>More on authentication methods</h2><p><a href=https://kubernetes-sigs.github.io/cloud-provider-azure/install/configs/><code>/etc/kubernetes/azure.json</code></a> is a well-known JSON file in each node that provides the details about which method MIC uses for authentication:</p><table><thead><tr><th>Authentication method</th><th><code>/etc/kubernetes/azure.json</code> fields used</th></tr></thead><tbody><tr><td>System-assigned managed identity</td><td><code>useManagedIdentityExtension: true</code> and <code>userAssignedIdentityID:""</code></td></tr><tr><td>User-assigned managed identity</td><td><code>useManagedIdentityExtension: true</code> and <code>userAssignedIdentityID:"&lt;UserAssignedIdentityID>"</code></td></tr><tr><td>Service principal (default)</td><td><code>aadClientID: "&lt;AADClientID>"</code> and <code>aadClientSecret: "&lt;AADClientSecret>"</code></td></tr></tbody></table><h2 id=obtaining-the-id-of-the-managed-identity--service-principal>Obtaining the ID of the managed identity / service principal</h2><p>After your cluster is provisioned, depending on your cluster identity configuration, run one of the following commands to retrieve the <strong>ID</strong> of your managed identity or service principal, which will be used for role assignment in the next section:</p><table><thead><tr><th>Cluster configuration</th><th>Command</th></tr></thead><tbody><tr><td>AKS cluster with service principal</td><td><code>az aks show -g &lt;AKSResourceGroup> -n &lt;AKSClusterName> --query servicePrincipalProfile.clientId -otsv</code></td></tr><tr><td>AKS cluster with managed identity</td><td><code>az aks show -g &lt;AKSResourceGroup> -n &lt;AKSClusterName> --query identityProfile.kubeletidentity.clientId -otsv</code></td></tr><tr><td>aks-engine cluster with service principal</td><td>Use the client ID of the service principal defined in the API model</td></tr><tr><td>aks-engine cluster with system-assigned identity</td><td><code>az &lt;vm|vmss> identity show -g &lt;NodeResourceGroup> -n &lt;VM|VMSS Name> --query principalId -otsv</code></td></tr><tr><td>aks-engine cluster with user-assigned identity</td><td><code>az &lt;vm|vmss> identity show -g &lt;NodeResourceGroup> -n &lt;VM|VMSS Name> --query userAssignedIdentities -otsv</code>, then copy the <code>clientID</code> of the selected user-assigned identity</td></tr></tbody></table><h2 id=performing-role-assignments>Performing role assignments</h2><p>The roles <a href=https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#managed-identity-operator><strong>Managed Identity Operator</strong></a> and <a href=https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-contributor><strong>Virtual Machine Contributor</strong></a> must be assigned to the cluster managed identity or service principal, identified by the <strong>ID</strong> obtained above, before deploying AAD Pod Identity so that it can assign and un-assign identities from the underlying VM/VMSS.</p><blockquote><p>For AKS cluster, the node resource group refers to the resource group with a <code>MC_</code> prefix, which contains all of the infrastructure resources associated with the cluster like VM/VMSS.</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az role assignment create --role <span style=color:#4e9a06>&#34;Managed Identity Operator&#34;</span> --assignee &lt;ID&gt; --scope /subscriptions/&lt;SubscriptionID&gt;/resourcegroups/&lt;NodeResourceGroup&gt;
az role assignment create --role <span style=color:#4e9a06>&#34;Virtual Machine Contributor&#34;</span> --assignee &lt;ID&gt; --scope /subscriptions/&lt;SubscriptionID&gt;/resourcegroups/&lt;NodeResourceGroup&gt;
</code></pre></div><blockquote><p>RBAC and non-RBAC clusters require the same role assignments.</p></blockquote><h2 id=user-assigned-identities-that-are-not-within-the-node-resource-group>User-assigned identities that are not within the node resource group</h2><p>There are additional role assignments required if you wish to assign user-assigned identities that are not within the node resource group. You can run the following command to assign the <strong>Managed Identity Operator</strong> role with the identity resource group scope:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az role assignment create --role <span style=color:#4e9a06>&#34;Managed Identity Operator&#34;</span> --assignee &lt;ID&gt; --scope /subscriptions/&lt;SubscriptionID&gt;/resourcegroups/&lt;IdentityResourceGroup&gt;
</code></pre></div><p>To enable fine-grained control on which user-assigned identity the cluster has access to, run the following command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az role assignment create --role <span style=color:#4e9a06>&#34;Managed Identity Operator&#34;</span> --assignee &lt;ID&gt;  --scope /subscriptions/&lt;SubscriptionID&gt;/resourcegroups/&lt;IdentityResourceGroup&gt;/providers/Microsoft.ManagedIdentity/userAssignedIdentities/&lt;IdentityName&gt;
</code></pre></div><h2 id=user-assigned-managed-identities-for-self-managed-clusters>User-assigned managed identities for self-managed clusters</h2><p>If you deploy the VMs and install Kubernetes instead of using tools like <a href=https://github.com/Azure/aks-engine>aks-engine</a> or <a href=https://github.com/kubernetes-sigs/cluster-api-provider-azure>capz</a>, you&rsquo;ll need to assign the user-assigned managed identity to the underlying VMs.</p><h3 id=for-vmss>For VMSS</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az vmss identity assign -n &lt;VMSS name&gt; -g &lt;rg&gt; --identities &lt;IdentityResourceID&gt;
</code></pre></div><h3 id=for-vms>For VMs</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az vm identity assign -n &lt;VM name&gt; -g &lt;rg&gt; --identities &lt;IdentityResourceID&gt;
</code></pre></div><p>Repeat for all your worker node VMs.</p><h2 id=reducing-number-of-role-assignments>Reducing number of role assignments</h2><p>Currently there&rsquo;s a limit of <a href=https://docs.microsoft.com/en-us/azure/role-based-access-control/troubleshooting#azure-role-assignments-limit>2000 role assignments</a> allowed within an Azure subscription. Once you&rsquo;ve hit this limit, you will not be able to assign new roles.</p><p>To reduce the number of role assignments, one thing you could do is instead of assigning the <code>Managed Identity Operator</code> role to managed identities individually, you could assign the <code>Managed Identity Operator</code> role to the resource group the managed identities belong to. Resources will inherit roles from the resource group, meaning you can create as many managed identities as you need and not affect the subscription&rsquo;s overall role assignment count.</p><h2 id=useful-links>Useful links</h2><ul><li><a href=https://docs.microsoft.com/en-us/azure/aks/use-managed-identity>Use managed identities in AKS</a></li><li><a href=https://docs.microsoft.com/en-us/azure/aks/kubernetes-service-principal>Service principals with AKS</a></li><li><a href=https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview>What are managed identities for Azure resources?</a></li></ul><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="feedback--answer feedback--answer-yes">Yes</button>
<button class="feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/Azure/aad-pod-identity/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/Azure/aad-pod-identity/issues/new>tell us how we can improve</a>.</p><script>const yesButton=document.querySelector('.feedback--answer-yes');const noButton=document.querySelector('.feedback--answer-no');const yesResponse=document.querySelector('.feedback--response-yes');const noResponse=document.querySelector('.feedback--response-no');const disableButtons=()=>{yesButton.disabled=true;noButton.disabled=true;};const sendFeedback=(value)=>{if(typeof ga!=='function')return;const args={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:value};ga(args.command,args.hitType,args.category,args.action,args.label,args.value);};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible');disableButtons();sendFeedback(1);});noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible');disableButtons();sendFeedback(0);});</script><br><div class="text-muted mt-5 pt-3 border-top">Last modified February 16, 2021: <a href=https://github.com/Azure/aad-pod-identity/commit/feb92a151477a0c20cf260e27e3a79d1e476a7c3>Add self-managed cluster configuration (#971) (feb92a1)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/Azure/aad-pod-identity><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2021 Azure Compute OSS Upstream Team All Rights Reserved</small></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/aad-pod-identity/js/main.min.664f21bf5eb0c31ebc661e2616e6c63e0448cec6d5636d869957be423c3cb952.js integrity="sha256-Zk8hv16wwx68Zh4mFubGPgRIzsbVY22GmVe+Qjw8uVI=" crossorigin=anonymous></script></body></html>