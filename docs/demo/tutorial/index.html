<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.75.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/aad-pod-identity/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/aad-pod-identity/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/aad-pod-identity/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/aad-pod-identity/favicons/android-192x192.png sizes=192x192><title>AAD Pod Identity Tutorial | Azure Active Directory Pod Identity for Kubernetes</title><meta property="og:title" content="AAD Pod Identity Tutorial"><meta property="og:description" content="A step by step tutorial for deploying AAD Pod Identity"><meta property="og:type" content="article"><meta property="og:url" content="https://azure.github.io/aad-pod-identity/docs/demo/tutorial/"><meta property="article:modified_time" content="2020-10-14T12:23:04-07:00"><meta property="og:site_name" content="Azure Active Directory Pod Identity for Kubernetes"><meta itemprop=name content="AAD Pod Identity Tutorial"><meta itemprop=description content="A step by step tutorial for deploying AAD Pod Identity"><meta itemprop=dateModified content="2020-10-14T12:23:04-07:00"><meta itemprop=wordCount content="954"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="AAD Pod Identity Tutorial"><meta name=twitter:description content="A step by step tutorial for deploying AAD Pod Identity"><link rel=preload href=/aad-pod-identity/scss/main.min.fbc3f081c4a76030d5aadfa83fde16b4e10de871bea1d0e592dccd7bfc3e5b64.css as=style><link href=/aad-pod-identity/scss/main.min.fbc3f081c4a76030d5aadfa83fde16b4e10de871bea1d0e592dccd7bfc3e5b64.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/aad-pod-identity/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Azure Active Directory Pod Identity for Kubernetes</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/aad-pod-identity/changelog/><span>Changelog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/aad-pod-identity/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/Azure/aad-pod-identity target=_blank><span>GitHub</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/aad-pod-identity/offline-search-index.d16af25c2496cecf74221304e08ce3023d9552cd66dc8e4cfffcc11d6bd68aa9c28b718230800b5128dc61e76adb631a1be2d481b552b7a1751a923bdc88733a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/aad-pod-identity/offline-search-index.d16af25c2496cecf74221304e08ce3023d9552cd66dc8e4cfffcc11d6bd68aa9c28b718230800b5128dc61e76adb631a1be2d481b552b7a1751a923bdc88733a.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Documentation</a></li><ul><li class="collapse show" id=aad-pod-identitydocs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/getting-started/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Getting Started</a></li><ul><li class=collapse id=aad-pod-identitydocsgetting-started><a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsgetting-startedrole-assignment href=/aad-pod-identity/docs/getting-started/role-assignment/>Role Assignment</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsgetting-startedinstallation href=/aad-pod-identity/docs/getting-started/installation/>Installation</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/concepts/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Concepts</a></li><ul><li class=collapse id=aad-pod-identitydocsconcepts><a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsazureidentity href=/aad-pod-identity/docs/concepts/azureidentity/>AzureIdentity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsazureidentitybinding href=/aad-pod-identity/docs/concepts/azureidentitybinding/>AzureIdentityBinding</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsazureassignedidentity href=/aad-pod-identity/docs/concepts/azureassignedidentity/>AzureAssignedIdentity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsazurepodidentityexception href=/aad-pod-identity/docs/concepts/azurepodidentityexception/>AzurePodIdentityException</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsmic href=/aad-pod-identity/docs/concepts/mic/>Managed Identity Controller (MIC)</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsnmi href=/aad-pod-identity/docs/concepts/nmi/>Node Managed Identity (NMI)</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconceptsblock-diagram-and-design href=/aad-pod-identity/docs/concepts/block-diagram-and-design/>Block Diagram and Design</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/demo/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Demos</a></li><ul><li class="collapse show" id=aad-pod-identitydocsdemo><a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsdemostandard_walkthrough href=/aad-pod-identity/docs/demo/standard_walkthrough/>Standard Walkthrough</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-aad-pod-identitydocsdemotutorial href=/aad-pod-identity/docs/demo/tutorial/>AAD Pod Identity Tutorial</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsdemojava-blob href=/aad-pod-identity/docs/demo/java-blob/>Spring Boot + Azure Storage + AAD Pod Identity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsdemoquickstart href=/aad-pod-identity/docs/demo/quickstart/>Quickstart Demo</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/configure/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Configurations</a></li><ul><li class=collapse id=aad-pod-identitydocsconfigure><a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigurematch_pods_in_namespace href=/aad-pod-identity/docs/configure/match_pods_in_namespace/>Match Pods in the Namespace</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureaad_pod_identity_on_kubenet href=/aad-pod-identity/docs/configure/aad_pod_identity_on_kubenet/>Deploy AAD Pod Identity in a Cluster with Kubenet</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfiguredeploy_aad_pod_dedicated_sp href=/aad-pod-identity/docs/configure/deploy_aad_pod_dedicated_sp/>Deploy AAD Pod Identity with a Dedicated Service Principal</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfiguredeploy_in_openshift href=/aad-pod-identity/docs/configure/deploy_in_openshift/>Setup AAD Pod Identity on Azure RedHat OpenShift (ARO)</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureapplication_exception href=/aad-pod-identity/docs/configure/application_exception/>Disable AAD Pod Identity for a specific Pod/Application</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureazure_identity_validation href=/aad-pod-identity/docs/configure/azure_identity_validation/>Azure Identity Validation using Gatekeeper</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigurefeature_flags href=/aad-pod-identity/docs/configure/feature_flags/>Feature Flags</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigurecustom_cloud href=/aad-pod-identity/docs/configure/custom_cloud/>Pod Identity in Custom Cloud</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigurestandard_to_managed_mode href=/aad-pod-identity/docs/configure/standard_to_managed_mode/>Migrating from Standard to Managed Mode</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigurepod_identity_in_managed_mode href=/aad-pod-identity/docs/configure/pod_identity_in_managed_mode/>Pod Identity in Managed Mode</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureprometheus_monitoring href=/aad-pod-identity/docs/configure/prometheus_monitoring/>Monitoring Pod Identity with Prometheus</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-aad-pod-identitydocsconfigureenable_psp_enabled_clusters href=/aad-pod-identity/docs/configure/enable_psp_enabled_clusters/>Enable PSP Clusters</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/best-practices/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Best Practices</a></li><ul><li class=collapse id=aad-pod-identitydocsbest-practices></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/known-issues/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Known Issues</a></li><ul><li class=collapse id=aad-pod-identitydocsknown-issues></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/contributing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Contributing</a></li><ul><li class=collapse id=aad-pod-identitydocscontributing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/troubleshooting/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Troubleshooting</a></li><ul><li class=collapse id=aad-pod-identitydocstroubleshooting></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/support/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Support</a></li><ul><li class=collapse id=aad-pod-identitydocssupport></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/aad-pod-identity/docs/code-of-conduct/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Code of Conduct</a></li><ul><li class=collapse id=aad-pod-identitydocscode-of-conduct></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/Azure/aad-pod-identity/edit/master/website/content/en/docs/Demo/tutorial.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/Azure/aad-pod-identity/issues/new?title=AAD%20Pod%20Identity%20Tutorial" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href="https://github.com/Azure/aad-pod-identity/issues/new?assignees=&labels=bug&template=bug_report.md&title=/issues/new" target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a><ul><li><a href=#using-azure-cli-kubectl-and-bash>Using Azure CLI, kubectl and bash</a></li></ul></li><li><a href=#1-create-a-kubernetes-cluster-on-azure-aks>1. Create a Kubernetes Cluster on Azure (AKS)</a><ul><li><a href=#11-register-the-required-resource-types>1.1. Register the required resource types</a></li><li><a href=#12-create-a-resource-group>1.2. Create a Resource Group</a></li><li><a href=#13-create-azure-kubernetes-service>1.3. Create Azure Kubernetes Service</a></li><li><a href=#14-configure-the-kubernetes-cli---kubectl>1.4. Configure the kubernetes CLI - <code>kubectl</code></a></li></ul></li><li><a href=#2-configure-aks-with-required-infrastructure-on-the-cluster>2. Configure AKS with required infrastructure on the cluster</a></li><li><a href=#3-deploy-the-demo>3. Deploy the demo</a><ul><li><a href=#31-create-an-azure-id>3.1. Create an Azure Id</a></li><li><a href=#32-deploy-demo>3.2. Deploy demo</a></li><li><a href=#33-deploy-azure-id-to-kubernetes>3.3. Deploy Azure Id to Kubernetes</a></li><li><a href=#34-bind-the-id-to-our-demo-pod>3.4. Bind the Id to our demo pod</a></li></ul></li><li><a href=#did-it-work>Did it work?</a><ul><li><a href=#check-the-managed-identity-controller-pod>Check the Managed Identity Controller pod</a></li><li><a href=#check-the-node-managed-identity-pod>Check the Node Managed Identity pod</a></li><li><a href=#check-the-demo-pod>Check the demo pod</a></li><li><a href=#check-the-descriptions>Check the descriptions</a></li><li><a href=#aad-pod-identity-in-action>AAD Pod Identity In Action</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=https://azure.github.io/aad-pod-identity/docs/>Documentation</a></li><li class=breadcrumb-item><a href=https://azure.github.io/aad-pod-identity/docs/demo/>Demos</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://azure.github.io/aad-pod-identity/docs/demo/tutorial/>AAD Pod Identity Tutorial</a></li></ol></nav><div class=td-content><h1>AAD Pod Identity Tutorial</h1><div class=lead>A step by step tutorial for deploying AAD Pod Identity</div><p>This tutorial is based on <a href=https://github.com/xtellurian/aad-pods>this repository</a>.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><a href=https://azure.microsoft.com/en-us/free/>Azure Account</a></li></ul><p>In this tutorial we are going to be using the Azure CLI, bash scripts, and kubectl. There are three sections, and each section contains several scripts to run. You&rsquo;ll find all the scripts in the <code>tutorial</code> directory.</p><p>To begin, clone this repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>git clone https://github.com/Azure/aad-pod-identity
<span style=color:#204a87>cd</span> aad-pod-identity/tutorial
</code></pre></div><h3 id=using-azure-cli-kubectl-and-bash>Using Azure CLI, kubectl and bash</h3><p>The following steps require the <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Azure CLI</a>, make sure to download and <a href="https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli?view=azure-cli-latest">login</a> before starting.</p><p>If you&rsquo;re on Windows, you should use <a href=https://docs.microsoft.com/en-us/windows/wsl/install-win10>Windows Subsystem for Linux</a> or another Bash terminal.</p><p>You can install kubectl via the Azure CLI, or by <a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/>another method</a></p><p><code>az aks install-cli</code></p><h2 id=1-create-a-kubernetes-cluster-on-azure-aks>1. Create a Kubernetes Cluster on Azure (AKS)</h2><h3 id=11-register-the-required-resource-types>1.1. Register the required resource types</h3><p><code>./1-init-aks/1-azure-provider-registration.sh</code></p><p>AKS requires the following resources: Microsoft.Network, Microsoft.Storage, Microsoft.Compute, Microsoft.ContainerService. Register them on your subscription with the above script.</p><h3 id=12-create-a-resource-group>1.2. Create a Resource Group</h3><p>Set an environment variable in your shell, for the name of your resource group.</p><p><code>export RG="k8s-test"</code></p><p>This resource group is for your AKS cluster. Create it with this command.</p><p><code>./1-init-aks/2-create-rg.sh</code></p><h3 id=13-create-azure-kubernetes-service>1.3. Create Azure Kubernetes Service</h3><p>This will create an AKS instance in the resource group created above. It may take a couple of minutes to complete. Set the name of the this command in the shell.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#000>K8S_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;Cluster-Name&#34;</span>
./1-init-aks/3-create-aks.sh
</code></pre></div><h3 id=14-configure-the-kubernetes-cli---kubectl>1.4. Configure the kubernetes CLI - <code>kubectl</code></h3><p>With <code>kubectl</code> installed, run the following script</p><p><code>./1-init-aks/4-configure-cli.sh</code></p><p>Now the <code>kubectl</code> command should control your AKS cluster. Try it out, it should look similar to below:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ kubectl get nodes
NAME                       STATUS    ROLES     AGE       VERSION
aks-nodepool1-15831963-0   Ready     agent     01h       v1.9.6
</code></pre></div><h2 id=2-configure-aks-with-required-infrastructure-on-the-cluster>2. Configure AKS with required infrastructure on the cluster</h2><p>Pod Identity requires two components:</p><ol><li>Managed Identity Controller (MIC). A pod that binds Azure Ids to other pods - creates azureAssignedIdentity CRD.</li><li>Node Managed Identity (NMI). Identifies the pod based on the remote address of the incoming request, and then queries the k8s (through MIC) for a matching Azure Id. It then make a adal request to get the token for the client id and returns as a response to the request. Implemented as a <a href=https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/>DaemonSet</a>.</li></ol><p>Deploy the infrastructure with the following command to deploy MIC, NMI, and MIC CRDs.</p><p><code>./2-config-aks/2-deploy-infra.sh</code></p><p>NOTE: If you have RBAC enabled, use the following deployment instead:</p><pre><code>kubectl create -f ../../deploy/infra/deployment-rbac.yaml
</code></pre><h2 id=3-deploy-the-demo>3. Deploy the demo</h2><p>The demo is basic, but does prove the concept.</p><h3 id=31-create-an-azure-id>3.1. Create an Azure Id</h3><p>We will be assigning the demo pod an <a href=https://docs.microsoft.com/en-us/azure/active-directory/managed-service-identity/overview>Azure Managed Service Identity</a>. The Azure Id will need to be in the same Resource Group <em>as was created automatically by the provisioning of the AKS cluster</em> <a href=https://github.com/Azure/aad-pod-identity/issues/38>see this issue for more information</a>.</p><p>You might find the Resource Group name with</p><p><code>az group list | grep $RG</code></p><p>Then set the environment variable</p><p><code>export MC_RG="resource-group-name"</code></p><p>Run the following to create an azure id</p><p><code>./3-deploy-demo/1-create-azure-id.sh</code></p><h3 id=32-deploy-demo>3.2. Deploy demo</h3><p>The <code>/deploy/demo/deployment.yaml</code> describes the pod that will be deployed.</p><p>It automatically adds the following values from your environment:</p><ul><li>subscriptionid: Id of your Azure Subscription</li><li>clientid: From the Azure Id you created in the step above</li><li>resourcegroup: From the Azure Id you created above</li></ul><p>Run the following to deploy the demo</p><p><code>./3-deploy-demo/2-deploy-demo.sh</code></p><h3 id=33-deploy-azure-id-to-kubernetes>3.3. Deploy Azure Id to Kubernetes</h3><p>We need to tell the cluster about the Id we created, so it can bind it to the pod (the next step). To do that, we will deploy the spec found in <code>/deploy/demo/aadpodidentity.yaml</code>.</p><p>Run the following to deploy the Azure ID to Kubernetes:</p><p><code>./3-deploy-demo/3-deploy-id-to-k8s.sh</code></p><h3 id=34-bind-the-id-to-our-demo-pod>3.4. Bind the Id to our demo pod</h3><p>Last thing we need to do is bind the Id we created in step 1, and deployed in step 3, to the pod we deployed in step 2.</p><p>Deploy the binding with the following</p><p><code>./3-deploy-demo/4-deploy-id-binding.sh</code></p><h2 id=did-it-work>Did it work?</h2><p>You&rsquo;ll need to check the logs of each pod to know if everything worked.</p><p>First, get the pod names with the following command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ kubectl get pods
NAME                   READY     STATUS    RESTARTS   AGE
demo-757967c54-64pzr   1/1       Running   <span style=color:#0000cf;font-weight:700>0</span>          1h     <span style=color:#8f5902;font-style:italic># the demo pod</span>
mic-64ddcf5f65-h4hft   1/1       Running   <span style=color:#0000cf;font-weight:700>0</span>          19h    <span style=color:#8f5902;font-style:italic># the MIC pod</span>
nmi-b9xbg              1/1       Running   <span style=color:#0000cf;font-weight:700>0</span>          1h     <span style=color:#8f5902;font-style:italic># the NMI pod</span>
</code></pre></div><h3 id=check-the-managed-identity-controller-pod>Check the Managed Identity Controller pod</h3><p>Check the logs of the MIC controller and see the binding successfully applied on the node.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ kubectl logs mic-64ddcf5f65-h4hft
....
I0606 23:19:45.867711       <span style=color:#0000cf;font-weight:700>1</span> crd.go:123<span style=color:#ce5c00;font-weight:700>]</span> Got id podid to assign
I0606 23:19:45.867829       <span style=color:#0000cf;font-weight:700>1</span> crd.go:142<span style=color:#ce5c00;font-weight:700>]</span> Creating assigned Id: demo-5788d95785-ghzwv-default-podid
I0606 23:19:45.874002       <span style=color:#0000cf;font-weight:700>1</span> cloudprovider.go:170<span style=color:#ce5c00;font-weight:700>]</span> Find aks-nodepool1-15831963-0 in resource group: MC_k8s-test_clusterFrank_eastus
I0606 23:20:11.051552       <span style=color:#0000cf;font-weight:700>1</span> cloudprovider.go:162<span style=color:#ce5c00;font-weight:700>]</span> Underlying cloud provider operation took 25.04421296s
I0606 23:20:11.051846       <span style=color:#0000cf;font-weight:700>1</span> mic.go:259<span style=color:#ce5c00;font-weight:700>]</span> Sync took: 25.220821436s
I0606 23:20:11.052905       <span style=color:#0000cf;font-weight:700>1</span> event.go:218<span style=color:#ce5c00;font-weight:700>]</span> Event<span style=color:#ce5c00;font-weight:700>(</span>v1.ObjectReference<span style=color:#ce5c00;font-weight:700>{</span>Kind:<span style=color:#4e9a06>&#34;AzureIdentityBinding&#34;</span>, Namespace:<span style=color:#4e9a06>&#34;default&#34;</span>, Name:<span style=color:#4e9a06>&#34;myIdBinding&#34;</span>, UID:<span style=color:#4e9a06>&#34;19a07e0e-69e0-11e8-9e9f-4addade2df92&#34;</span>, APIVersion:<span style=color:#4e9a06>&#34;aadpodidentity.k8s.io/v1&#34;</span>, ResourceVersion:<span style=color:#4e9a06>&#34;89529&#34;</span>, FieldPath:<span style=color:#4e9a06>&#34;&#34;</span><span style=color:#ce5c00;font-weight:700>})</span>: type: <span style=color:#4e9a06>&#39;Normal&#39;</span> reason: <span style=color:#4e9a06>&#39;binding applied&#39;</span> Binding myIdBinding applied on node aks-nodepool1-15831963-0 <span style=color:#204a87;font-weight:700>for</span> pod demo-5788d95785-ghzwv-default-podid
</code></pre></div><h3 id=check-the-node-managed-identity-pod>Check the Node Managed Identity pod</h3><p>Check the logs of the NMI pod to see only info level logging and 200 responses. If you see 403 or 404 responses, then something is wrong.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ kubectl logs nmi-b9xbg
...
<span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;2018-06-07T01:30:04Z&#34;</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>=</span>info <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;Status (200) took 55422159 ns&#34;</span> req.method<span style=color:#ce5c00;font-weight:700>=</span>GET req.path<span style=color:#ce5c00;font-weight:700>=</span>/metadata/identity/oauth2/token req.remote<span style=color:#ce5c00;font-weight:700>=</span>10.244.0.25
<span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;2018-06-07T01:30:04Z&#34;</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>=</span>info <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;matched identityType:0 clientid:a40e83f9-6198-4633-afae-d860eb5b7f7c resource:https://management.azure.com/&#34;</span> req.method<span style=color:#ce5c00;font-weight:700>=</span>GET req.path<span style=color:#ce5c00;font-weight:700>=</span>/metadata/identity/oauth2/token req.remote<span style=color:#ce5c00;font-weight:700>=</span>10.244.0.25
</code></pre></div><h3 id=check-the-demo-pod>Check the demo pod</h3><p>The demo pod should be reporting on the virtual machines in the resource group. If you see intermittant 403 responses, that is OK.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ kubectl logs demo-757967c54-64pzr
...
<span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;2018-06-07T01:32:30Z&#34;</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>=</span>error <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;failed list all vm compute.VirtualMachinesClient#List: Failure responding to request: StatusCode=403 -- Original Error: autorest/azure: Service returned an error. Status=403 Code=\&#34;AuthorizationFailed\&#34; Message=\&#34;The client &#39;48affddb-9972-4b7e-a82b-c5d32d2a3dd5&#39; with object id &#39;48affddb-9972-4b7e-a82b-c5d32d2a3dd5&#39; does not have authorization to perform action &#39;Microsoft.Compute/virtualMachines/read&#39; over scope &#39;/subscriptions/c5760548-23c2-4223-b41e-5d68a8320a0c/resourceGroups/MC_k8s-test_clusterFrank_eastus/providers/Microsoft.Compute&#39;.\&#34;&#34;</span> <span style=color:#000>podip</span><span style=color:#ce5c00;font-weight:700>=</span>10.244.0.25 <span style=color:#000>podname</span><span style=color:#ce5c00;font-weight:700>=</span>demo-757967c54-64pzr <span style=color:#000>podnamespace</span><span style=color:#ce5c00;font-weight:700>=</span>demo-757967c54-64pzr
<span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;2018-06-07T01:32:30Z&#34;</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>=</span>info <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;successfully acquired a token using the MSI, msiEndpoint(http://169.254.169.254/metadata/identity/oauth2/token)&#34;</span> <span style=color:#000>podip</span><span style=color:#ce5c00;font-weight:700>=</span>10.244.0.25 <span style=color:#000>podname</span><span style=color:#ce5c00;font-weight:700>=</span>demo-757967c54-64pzr <span style=color:#000>podnamespace</span><span style=color:#ce5c00;font-weight:700>=</span>demo-757967c54-64pzr
<span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;2018-06-07T01:32:30Z&#34;</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>=</span>info <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;successfully acquired a token, userAssignedID MSI, msiEndpoint(http://169.254.169.254/metadata/identity/oauth2/token) clientID(a40e83f9-6198-4633-afae-d860eb5b7f7c)&#34;</span> <span style=color:#000>podip</span><span style=color:#ce5c00;font-weight:700>=</span>10.244.0.25 <span style=color:#000>podname</span><span style=color:#ce5c00;font-weight:700>=</span>demo-757967c54-64pzr <span style=color:#000>podnamespace</span><span style=color:#ce5c00;font-weight:700>=</span>demo-757967c54-64pzr
<span style=color:#000>time</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;2018-06-07T01:32:30Z&#34;</span> <span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>=</span>info <span style=color:#000>msg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;successfully made GET on instance metadata, {\&#34;compute\&#34;:{\&#34;location\&#34;:\&#34;eastus\&#34;,\&#34;name\&#34;:\&#34;aks-nodepool1-15831963-0\&#34;,\&#34;offer\&#34;:\&#34;UbuntuServer\&#34;,\&#34;osType\&#34;:\&#34;Linux\&#34;,\&#34;placementGroupId\&#34;:\&#34;\&#34;,\&#34;platformFaultDomain\&#34;:\&#34;0\&#34;,\&#34;platformUpdateDomain\&#34;:\&#34;0\&#34;,\&#34;publisher\&#34;:\&#34;Canonical\&#34;,\&#34;resourceGroupName\&#34;:\&#34;MC_k8s-test_clusterFrank_eastus\&#34;,\&#34;sku\&#34;:\&#34;16.04-LTS\&#34;,\&#34;subscriptionId\&#34;:\&#34;c5760548-23c2-4223-b41e-5d68a8320a0c\&#34;,\&#34;tags\&#34;:\&#34;acsengineVersion:v0.17.0-aks;creationSource:aks-aks-nodepool1-15831963-0;orchestrator:Kubernetes:1.9.6;poolName:nodepool1;resourceNameSuffix:15831963\&#34;,\&#34;version\&#34;:\&#34;16.04.201805090\&#34;,\&#34;vmId\&#34;:\&#34;3fea4c7e-4aaf-400f-a588-2a851f6fd0cf\&#34;,\&#34;vmSize\&#34;:\&#34;Standard_DS1_v2\&#34;},\&#34;network\&#34;:{\&#34;interface\&#34;:[{\&#34;ipv4\&#34;:{\&#34;ipAddress\&#34;:[{\&#34;privateIpAddress\&#34;:\&#34;10.240.0.4\&#34;,\&#34;publicIpAddress\&#34;:\&#34;\&#34;}],\&#34;subnet\&#34;:[{\&#34;address\&#34;:\&#34;10.240.0.0\&#34;,\&#34;prefix\&#34;:\&#34;16\&#34;}]},\&#34;ipv6\&#34;:{\&#34;ipAddress\&#34;:[]},\&#34;macAddress\&#34;:\&#34;000D3A13DEE3\&#34;}]}}&#34;</span> <span style=color:#000>podip</span><span style=color:#ce5c00;font-weight:700>=</span>10.244.0.25 <span style=color:#000>podname</span><span style=color:#ce5c00;font-weight:700>=</span>demo-757967c54-64pzr <span style=color:#000>podnamespace</span><span style=color:#ce5c00;font-weight:700>=</span>demo-757967c54-64pzr
</code></pre></div><h3 id=check-the-descriptions>Check the descriptions</h3><p><code>kubectl describe azureidentity</code></p><p><code>kubectl describe azureidentitybinding</code></p><h3 id=aad-pod-identity-in-action>AAD Pod Identity In Action</h3><p><a href="https://www.youtube.com/watch?v=BXhIMJYDO4w"><img src=https://img.youtube.com/vi/BXhIMJYDO4w/0.jpg alt="Video of Running required commands"></a></p><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="feedback--answer feedback--answer-yes">Yes</button>
<button class="feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/Azure/aad-pod-identity/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/Azure/aad-pod-identity/issues/new>tell us how we can improve</a>.</p><script>const yesButton=document.querySelector('.feedback--answer-yes');const noButton=document.querySelector('.feedback--answer-no');const yesResponse=document.querySelector('.feedback--response-yes');const noResponse=document.querySelector('.feedback--response-no');const disableButtons=()=>{yesButton.disabled=true;noButton.disabled=true;};const sendFeedback=(value)=>{if(typeof ga!=='function')return;const args={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:value};ga(args.command,args.hitType,args.category,args.action,args.label,args.value);};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible');disableButtons();sendFeedback(1);});noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible');disableButtons();sendFeedback(0);});</script><br><div class="text-muted mt-5 pt-3 border-top">Last modified October 14, 2020: <a href=https://github.com/Azure/aad-pod-identity/commit/0091ec9f3b6402eabd208be8b3f58b2ed0fe33c0>docs: update invalid URLs in website (#832) (0091ec9f)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/Azure/aad-pod-identity><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 Azure Compute OSS Upstream Team All Rights Reserved</small></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/aad-pod-identity/js/main.min.664f21bf5eb0c31ebc661e2616e6c63e0448cec6d5636d869957be423c3cb952.js integrity="sha256-Zk8hv16wwx68Zh4mFubGPgRIzsbVY22GmVe+Qjw8uVI=" crossorigin=anonymous></script></body></html>